<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>PojoUtils.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">dubbo-all</a> &gt; <a href="../index.html" class="el_bundle">dubbo-common</a> &gt; <a href="index.source.html" class="el_package">org.apache.dubbo.common.utils</a> &gt; <span class="el_source">PojoUtils.java</span></div><h1>PojoUtils.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.dubbo.common.utils;

import org.apache.dubbo.common.logger.Logger;
import org.apache.dubbo.common.logger.LoggerFactory;

import java.lang.reflect.Array;
import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Proxy;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.IdentityHashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.TreeMap;
import java.util.WeakHashMap;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;
import java.util.concurrent.ConcurrentSkipListMap;

/**
 * PojoUtils. Travel object deeply, and convert complex type to simple type.
 * &lt;p/&gt;
 * Simple type below will be remained:
 * &lt;ul&gt;
 * &lt;li&gt; Primitive Type, also include &lt;b&gt;String&lt;/b&gt;, &lt;b&gt;Number&lt;/b&gt;(Integer, Long), &lt;b&gt;Date&lt;/b&gt;
 * &lt;li&gt; Array of Primitive Type
 * &lt;li&gt; Collection, eg: List, Map, Set etc.
 * &lt;/ul&gt;
 * &lt;p/&gt;
 * Other type will be covert to a map which contains the attributes and value pair of object.
 */
<span class="nc" id="L61">public class PojoUtils {</span>

<span class="nc" id="L63">    private static final Logger logger = LoggerFactory.getLogger(PojoUtils.class);</span>
<span class="nc" id="L64">    private static final ConcurrentMap&lt;String, Method&gt; NAME_METHODS_CACHE = new ConcurrentHashMap&lt;String, Method&gt;();</span>
<span class="nc" id="L65">    private static final ConcurrentMap&lt;Class&lt;?&gt;, ConcurrentMap&lt;String, Field&gt;&gt; CLASS_FIELD_CACHE = new ConcurrentHashMap&lt;Class&lt;?&gt;, ConcurrentMap&lt;String, Field&gt;&gt;();</span>

    public static Object[] generalize(Object[] objs) {
<span class="nc" id="L68">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L70">            dests[i] = generalize(objs[i]);</span>
        }
<span class="nc" id="L72">        return dests;</span>
    }

    public static Object[] realize(Object[] objs, Class&lt;?&gt;[] types) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (objs.length != types.length) {</span>
<span class="nc" id="L77">            throw new IllegalArgumentException(&quot;args.length != types.length&quot;);</span>
        }

<span class="nc" id="L80">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L82">            dests[i] = realize(objs[i], types[i]);</span>
        }

<span class="nc" id="L85">        return dests;</span>
    }

    public static Object[] realize(Object[] objs, Class&lt;?&gt;[] types, Type[] gtypes) {
<span class="nc bnc" id="L89" title="All 4 branches missed.">        if (objs.length != types.length || objs.length != gtypes.length) {</span>
<span class="nc" id="L90">            throw new IllegalArgumentException(&quot;args.length != types.length&quot;);</span>
        }
<span class="nc" id="L92">        Object[] dests = new Object[objs.length];</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (int i = 0; i &lt; objs.length; i++) {</span>
<span class="nc" id="L94">            dests[i] = realize(objs[i], types[i], gtypes[i]);</span>
        }
<span class="nc" id="L96">        return dests;</span>
    }

    public static Object generalize(Object pojo) {
<span class="nc" id="L100">        return generalize(pojo, new IdentityHashMap&lt;Object, Object&gt;());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private static Object generalize(Object pojo, Map&lt;Object, Object&gt; history) {
<span class="nc bnc" id="L105" title="All 2 branches missed.">        if (pojo == null) {</span>
<span class="nc" id="L106">            return null;</span>
        }

<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (pojo instanceof Enum&lt;?&gt;) {</span>
<span class="nc" id="L110">            return ((Enum&lt;?&gt;) pojo).name();</span>
        }
<span class="nc bnc" id="L112" title="All 4 branches missed.">        if (pojo.getClass().isArray() &amp;&amp; Enum.class.isAssignableFrom(pojo.getClass().getComponentType())) {</span>
<span class="nc" id="L113">            int len = Array.getLength(pojo);</span>
<span class="nc" id="L114">            String[] values = new String[len];</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L116">                values[i] = ((Enum&lt;?&gt;) Array.get(pojo, i)).name();</span>
            }
<span class="nc" id="L118">            return values;</span>
        }

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (ReflectUtils.isPrimitives(pojo.getClass())) {</span>
<span class="nc" id="L122">            return pojo;</span>
        }

<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (pojo instanceof Class) {</span>
<span class="nc" id="L126">            return ((Class) pojo).getName();</span>
        }

<span class="nc" id="L129">        Object o = history.get(pojo);</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (o != null) {</span>
<span class="nc" id="L131">            return o;</span>
        }
<span class="nc" id="L133">        history.put(pojo, pojo);</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (pojo.getClass().isArray()) {</span>
<span class="nc" id="L136">            int len = Array.getLength(pojo);</span>
<span class="nc" id="L137">            Object[] dest = new Object[len];</span>
<span class="nc" id="L138">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L140">                Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L141">                dest[i] = generalize(obj, history);</span>
            }
<span class="nc" id="L143">            return dest;</span>
        }
<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (pojo instanceof Collection&lt;?&gt;) {</span>
<span class="nc" id="L146">            Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L147">            int len = src.size();</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">            Collection&lt;Object&gt; dest = (pojo instanceof List&lt;?&gt;) ? new ArrayList&lt;Object&gt;(len) : new HashSet&lt;Object&gt;(len);</span>
<span class="nc" id="L149">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            for (Object obj : src) {</span>
<span class="nc" id="L151">                dest.add(generalize(obj, history));</span>
<span class="nc" id="L152">            }</span>
<span class="nc" id="L153">            return dest;</span>
        }
<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (pojo instanceof Map&lt;?, ?&gt;) {</span>
<span class="nc" id="L156">            Map&lt;Object, Object&gt; src = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L157">            Map&lt;Object, Object&gt; dest = createMap(src);</span>
<span class="nc" id="L158">            history.put(pojo, dest);</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">            for (Map.Entry&lt;Object, Object&gt; obj : src.entrySet()) {</span>
<span class="nc" id="L160">                dest.put(generalize(obj.getKey(), history), generalize(obj.getValue(), history));</span>
<span class="nc" id="L161">            }</span>
<span class="nc" id="L162">            return dest;</span>
        }
<span class="nc" id="L164">        Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L165">        history.put(pojo, map);</span>
<span class="nc" id="L166">        map.put(&quot;class&quot;, pojo.getClass().getName());</span>
<span class="nc bnc" id="L167" title="All 2 branches missed.">        for (Method method : pojo.getClass().getMethods()) {</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (ReflectUtils.isBeanPropertyReadMethod(method)) {</span>
                try {
<span class="nc" id="L170">                    map.put(ReflectUtils.getPropertyNameFromBeanReadMethod(method), generalize(method.invoke(pojo), history));</span>
<span class="nc" id="L171">                } catch (Exception e) {</span>
<span class="nc" id="L172">                    throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L173">                }</span>
            }
        }
        // public field
<span class="nc bnc" id="L177" title="All 2 branches missed.">        for (Field field : pojo.getClass().getFields()) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">            if (ReflectUtils.isPublicInstanceField(field)) {</span>
                try {
<span class="nc" id="L180">                    Object fieldValue = field.get(pojo);</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                    if (history.containsKey(pojo)) {</span>
<span class="nc" id="L182">                        Object pojoGeneralizedValue = history.get(pojo);</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                        if (pojoGeneralizedValue instanceof Map</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                                &amp;&amp; ((Map) pojoGeneralizedValue).containsKey(field.getName())) {</span>
<span class="nc" id="L185">                            continue;</span>
                        }
                    }
<span class="nc bnc" id="L188" title="All 2 branches missed.">                    if (fieldValue != null) {</span>
<span class="nc" id="L189">                        map.put(field.getName(), generalize(fieldValue, history));</span>
                    }
<span class="nc" id="L191">                } catch (Exception e) {</span>
<span class="nc" id="L192">                    throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L193">                }</span>
            }
        }
<span class="nc" id="L196">        return map;</span>
    }

    public static Object realize(Object pojo, Class&lt;?&gt; type) {
<span class="nc" id="L200">        return realize0(pojo, type, null, new IdentityHashMap&lt;Object, Object&gt;());</span>
    }

    public static Object realize(Object pojo, Class&lt;?&gt; type, Type genericType) {
<span class="nc" id="L204">        return realize0(pojo, type, genericType, new IdentityHashMap&lt;Object, Object&gt;());</span>
    }

    private static class PojoInvocationHandler implements InvocationHandler {

        private Map&lt;Object, Object&gt; map;

<span class="nc" id="L211">        public PojoInvocationHandler(Map&lt;Object, Object&gt; map) {</span>
<span class="nc" id="L212">            this.map = map;</span>
<span class="nc" id="L213">        }</span>

        @Override
        @SuppressWarnings(&quot;unchecked&quot;)
        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (method.getDeclaringClass() == Object.class) {</span>
<span class="nc" id="L219">                return method.invoke(map, args);</span>
            }
<span class="nc" id="L221">            String methodName = method.getName();</span>
<span class="nc" id="L222">            Object value = null;</span>
<span class="nc bnc" id="L223" title="All 4 branches missed.">            if (methodName.length() &gt; 3 &amp;&amp; methodName.startsWith(&quot;get&quot;)) {</span>
<span class="nc" id="L224">                value = map.get(methodName.substring(3, 4).toLowerCase() + methodName.substring(4));</span>
<span class="nc bnc" id="L225" title="All 4 branches missed.">            } else if (methodName.length() &gt; 2 &amp;&amp; methodName.startsWith(&quot;is&quot;)) {</span>
<span class="nc" id="L226">                value = map.get(methodName.substring(2, 3).toLowerCase() + methodName.substring(3));</span>
            } else {
<span class="nc" id="L228">                value = map.get(methodName.substring(0, 1).toLowerCase() + methodName.substring(1));</span>
            }
<span class="nc bnc" id="L230" title="All 4 branches missed.">            if (value instanceof Map&lt;?, ?&gt; &amp;&amp; !Map.class.isAssignableFrom(method.getReturnType())) {</span>
<span class="nc" id="L231">                value = realize0((Map&lt;String, Object&gt;) value, method.getReturnType(), null, new IdentityHashMap&lt;Object, Object&gt;());</span>
            }
<span class="nc" id="L233">            return value;</span>
        }
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    private static Collection&lt;Object&gt; createCollection(Class&lt;?&gt; type, int len) {
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (type.isAssignableFrom(ArrayList.class)) {</span>
<span class="nc" id="L240">            return new ArrayList&lt;Object&gt;(len);</span>
        }
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if (type.isAssignableFrom(HashSet.class)) {</span>
<span class="nc" id="L243">            return new HashSet&lt;Object&gt;(len);</span>
        }
<span class="nc bnc" id="L245" title="All 4 branches missed.">        if (!type.isInterface() &amp;&amp; !Modifier.isAbstract(type.getModifiers())) {</span>
            try {
<span class="nc" id="L247">                return (Collection&lt;Object&gt;) type.newInstance();</span>
<span class="nc" id="L248">            } catch (Exception e) {</span>
                // ignore
            }
        }
<span class="nc" id="L252">        return new ArrayList&lt;Object&gt;();</span>
    }

    private static Map createMap(Map src) {
<span class="nc" id="L256">        Class&lt;? extends Map&gt; cl = src.getClass();</span>
<span class="nc" id="L257">        Map result = null;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (HashMap.class == cl) {</span>
<span class="nc" id="L259">            result = new HashMap();</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">        } else if (Hashtable.class == cl) {</span>
<span class="nc" id="L261">            result = new Hashtable();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        } else if (IdentityHashMap.class == cl) {</span>
<span class="nc" id="L263">            result = new IdentityHashMap();</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">        } else if (LinkedHashMap.class == cl) {</span>
<span class="nc" id="L265">            result = new LinkedHashMap();</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">        } else if (Properties.class == cl) {</span>
<span class="nc" id="L267">            result = new Properties();</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        } else if (TreeMap.class == cl) {</span>
<span class="nc" id="L269">            result = new TreeMap();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if (WeakHashMap.class == cl) {</span>
<span class="nc" id="L271">            return new WeakHashMap();</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">        } else if (ConcurrentHashMap.class == cl) {</span>
<span class="nc" id="L273">            result = new ConcurrentHashMap();</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">        } else if (ConcurrentSkipListMap.class == cl) {</span>
<span class="nc" id="L275">            result = new ConcurrentSkipListMap();</span>
        } else {
            try {
<span class="nc" id="L278">                result = cl.newInstance();</span>
<span class="nc" id="L279">            } catch (Exception e) { /* ignore */ }</span>

<span class="nc bnc" id="L281" title="All 2 branches missed.">            if (result == null) {</span>
                try {
<span class="nc" id="L283">                    Constructor&lt;?&gt; constructor = cl.getConstructor(Map.class);</span>
<span class="nc" id="L284">                    result = (Map) constructor.newInstance(Collections.EMPTY_MAP);</span>
<span class="nc" id="L285">                } catch (Exception e) { /* ignore */ }</span>
            }
        }

<span class="nc bnc" id="L289" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L290">            result = new HashMap&lt;Object, Object&gt;();</span>
        }

<span class="nc" id="L293">        return result;</span>
    }

    @SuppressWarnings({&quot;unchecked&quot;, &quot;rawtypes&quot;})
    private static Object realize0(Object pojo, Class&lt;?&gt; type, Type genericType, final Map&lt;Object, Object&gt; history) {
<span class="nc bnc" id="L298" title="All 2 branches missed.">        if (pojo == null) {</span>
<span class="nc" id="L299">            return null;</span>
        }

<span class="nc bnc" id="L302" title="All 6 branches missed.">        if (type != null &amp;&amp; type.isEnum() &amp;&amp; pojo.getClass() == String.class) {</span>
<span class="nc" id="L303">            return Enum.valueOf((Class&lt;Enum&gt;) type, (String) pojo);</span>
        }

<span class="nc bnc" id="L306" title="All 4 branches missed.">        if (ReflectUtils.isPrimitives(pojo.getClass())</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                &amp;&amp; !(type != null &amp;&amp; type.isArray()</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">                &amp;&amp; type.getComponentType().isEnum()</span>
<span class="nc bnc" id="L309" title="All 2 branches missed.">                &amp;&amp; pojo.getClass() == String[].class)) {</span>
<span class="nc" id="L310">            return CompatibleTypeUtils.compatibleTypeConvert(pojo, type);</span>
        }

<span class="nc" id="L313">        Object o = history.get(pojo);</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (o != null) {</span>
<span class="nc" id="L316">            return o;</span>
        }

<span class="nc" id="L319">        history.put(pojo, pojo);</span>

<span class="nc bnc" id="L321" title="All 2 branches missed.">        if (pojo.getClass().isArray()) {</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">            if (Collection.class.isAssignableFrom(type)) {</span>
<span class="nc" id="L323">                Class&lt;?&gt; ctype = pojo.getClass().getComponentType();</span>
<span class="nc" id="L324">                int len = Array.getLength(pojo);</span>
<span class="nc" id="L325">                Collection dest = createCollection(type, len);</span>
<span class="nc" id="L326">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L328">                    Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L329">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L330">                    dest.add(value);</span>
                }
<span class="nc" id="L332">                return dest;</span>
            } else {
<span class="nc bnc" id="L334" title="All 4 branches missed.">                Class&lt;?&gt; ctype = (type != null &amp;&amp; type.isArray() ? type.getComponentType() : pojo.getClass().getComponentType());</span>
<span class="nc" id="L335">                int len = Array.getLength(pojo);</span>
<span class="nc" id="L336">                Object dest = Array.newInstance(ctype, len);</span>
<span class="nc" id="L337">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">                for (int i = 0; i &lt; len; i++) {</span>
<span class="nc" id="L339">                    Object obj = Array.get(pojo, i);</span>
<span class="nc" id="L340">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L341">                    Array.set(dest, i, value);</span>
                }
<span class="nc" id="L343">                return dest;</span>
            }
        }

<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (pojo instanceof Collection&lt;?&gt;) {</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">            if (type.isArray()) {</span>
<span class="nc" id="L349">                Class&lt;?&gt; ctype = type.getComponentType();</span>
<span class="nc" id="L350">                Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L351">                int len = src.size();</span>
<span class="nc" id="L352">                Object dest = Array.newInstance(ctype, len);</span>
<span class="nc" id="L353">                history.put(pojo, dest);</span>
<span class="nc" id="L354">                int i = 0;</span>
<span class="nc bnc" id="L355" title="All 2 branches missed.">                for (Object obj : src) {</span>
<span class="nc" id="L356">                    Object value = realize0(obj, ctype, null, history);</span>
<span class="nc" id="L357">                    Array.set(dest, i, value);</span>
<span class="nc" id="L358">                    i++;</span>
<span class="nc" id="L359">                }</span>
<span class="nc" id="L360">                return dest;</span>
            } else {
<span class="nc" id="L362">                Collection&lt;Object&gt; src = (Collection&lt;Object&gt;) pojo;</span>
<span class="nc" id="L363">                int len = src.size();</span>
<span class="nc" id="L364">                Collection&lt;Object&gt; dest = createCollection(type, len);</span>
<span class="nc" id="L365">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">                for (Object obj : src) {</span>
<span class="nc" id="L367">                    Type keyType = getGenericClassByIndex(genericType, 0);</span>
<span class="nc" id="L368">                    Class&lt;?&gt; keyClazz = obj.getClass();</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                    if (keyType instanceof Class) {</span>
<span class="nc" id="L370">                        keyClazz = (Class&lt;?&gt;) keyType;</span>
                    }
<span class="nc" id="L372">                    Object value = realize0(obj, keyClazz, keyType, history);</span>
<span class="nc" id="L373">                    dest.add(value);</span>
<span class="nc" id="L374">                }</span>
<span class="nc" id="L375">                return dest;</span>
            }
        }

<span class="nc bnc" id="L379" title="All 4 branches missed.">        if (pojo instanceof Map&lt;?, ?&gt; &amp;&amp; type != null) {</span>
<span class="nc" id="L380">            Object className = ((Map&lt;Object, Object&gt;) pojo).get(&quot;class&quot;);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            if (className instanceof String) {</span>
                try {
<span class="nc" id="L383">                    type = ClassUtils.forName((String) className);</span>
<span class="nc" id="L384">                } catch (ClassNotFoundException e) {</span>
                    // ignore
<span class="nc" id="L386">                }</span>
            }

            // special logic for enum
<span class="nc bnc" id="L390" title="All 2 branches missed.">            if (type.isEnum()) {</span>
<span class="nc" id="L391">                Object name = ((Map&lt;Object, Object&gt;) pojo).get(&quot;name&quot;);</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                if (name != null) {</span>
<span class="nc" id="L393">                    return Enum.valueOf((Class&lt;Enum&gt;) type, name.toString());</span>
                }
            }
            Map&lt;Object, Object&gt; map;
            // when return type is not the subclass of return type from the signature and not an interface
<span class="nc bnc" id="L398" title="All 4 branches missed.">            if (!type.isInterface() &amp;&amp; !type.isAssignableFrom(pojo.getClass())) {</span>
                try {
<span class="nc" id="L400">                    map = (Map&lt;Object, Object&gt;) type.newInstance();</span>
<span class="nc" id="L401">                    Map&lt;Object, Object&gt; mapPojo = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L402">                    map.putAll(mapPojo);</span>
<span class="nc" id="L403">                    map.remove(&quot;class&quot;);</span>
<span class="nc" id="L404">                } catch (Exception e) {</span>
                    //ignore error
<span class="nc" id="L406">                    map = (Map&lt;Object, Object&gt;) pojo;</span>
<span class="nc" id="L407">                }</span>
            } else {
<span class="nc" id="L409">                map = (Map&lt;Object, Object&gt;) pojo;</span>
            }

<span class="nc bnc" id="L412" title="All 4 branches missed.">            if (Map.class.isAssignableFrom(type) || type == Object.class) {</span>
<span class="nc" id="L413">                final Map&lt;Object, Object&gt; result = createMap(map);</span>
<span class="nc" id="L414">                history.put(pojo, result);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                for (Map.Entry&lt;Object, Object&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L416">                    Type keyType = getGenericClassByIndex(genericType, 0);</span>
<span class="nc" id="L417">                    Type valueType = getGenericClassByIndex(genericType, 1);</span>
                    Class&lt;?&gt; keyClazz;
<span class="nc bnc" id="L419" title="All 2 branches missed.">                    if (keyType instanceof Class) {</span>
<span class="nc" id="L420">                        keyClazz = (Class&lt;?&gt;) keyType;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                    } else if (keyType instanceof ParameterizedType) {</span>
<span class="nc" id="L422">                        keyClazz = (Class&lt;?&gt;) ((ParameterizedType) keyType).getRawType();</span>
                    } else {
<span class="nc bnc" id="L424" title="All 2 branches missed.">                        keyClazz = entry.getKey() == null ? null : entry.getKey().getClass();</span>
                    }
                    Class&lt;?&gt; valueClazz;
<span class="nc bnc" id="L427" title="All 2 branches missed.">                    if (valueType instanceof Class) {</span>
<span class="nc" id="L428">                        valueClazz = (Class&lt;?&gt;) valueType;</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">                    } else if (valueType instanceof ParameterizedType) {</span>
<span class="nc" id="L430">                        valueClazz = (Class&lt;?&gt;) ((ParameterizedType) valueType).getRawType();</span>
                    } else {
<span class="nc bnc" id="L432" title="All 2 branches missed.">                        valueClazz = entry.getValue() == null ? null : entry.getValue().getClass();</span>
                    }

<span class="nc bnc" id="L435" title="All 2 branches missed.">                    Object key = keyClazz == null ? entry.getKey() : realize0(entry.getKey(), keyClazz, keyType, history);</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                    Object value = valueClazz == null ? entry.getValue() : realize0(entry.getValue(), valueClazz, valueType, history);</span>
<span class="nc" id="L437">                    result.put(key, value);</span>
<span class="nc" id="L438">                }</span>
<span class="nc" id="L439">                return result;</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            } else if (type.isInterface()) {</span>
<span class="nc" id="L441">                Object dest = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(), new Class&lt;?&gt;[]{type}, new PojoInvocationHandler(map));</span>
<span class="nc" id="L442">                history.put(pojo, dest);</span>
<span class="nc" id="L443">                return dest;</span>
            } else {
<span class="nc" id="L445">                Object dest = newInstance(type);</span>
<span class="nc" id="L446">                history.put(pojo, dest);</span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                for (Map.Entry&lt;Object, Object&gt; entry : map.entrySet()) {</span>
<span class="nc" id="L448">                    Object key = entry.getKey();</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                    if (key instanceof String) {</span>
<span class="nc" id="L450">                        String name = (String) key;</span>
<span class="nc" id="L451">                        Object value = entry.getValue();</span>
<span class="nc bnc" id="L452" title="All 2 branches missed.">                        if (value != null) {</span>
<span class="nc" id="L453">                            Method method = getSetterMethod(dest.getClass(), name, value.getClass());</span>
<span class="nc" id="L454">                            Field field = getField(dest.getClass(), name);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                            if (method != null) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                                if (!method.isAccessible()) {</span>
<span class="nc" id="L457">                                    method.setAccessible(true);</span>
                                }
<span class="nc" id="L459">                                Type ptype = method.getGenericParameterTypes()[0];</span>
<span class="nc" id="L460">                                value = realize0(value, method.getParameterTypes()[0], ptype, history);</span>
                                try {
<span class="nc" id="L462">                                    method.invoke(dest, value);</span>
<span class="nc" id="L463">                                } catch (Exception e) {</span>
<span class="nc" id="L464">                                    String exceptionDescription = &quot;Failed to set pojo &quot; + dest.getClass().getSimpleName() + &quot; property &quot; + name</span>
<span class="nc" id="L465">                                            + &quot; value &quot; + value + &quot;(&quot; + value.getClass() + &quot;), cause: &quot; + e.getMessage();</span>
<span class="nc" id="L466">                                    logger.error(exceptionDescription, e);</span>
<span class="nc" id="L467">                                    throw new RuntimeException(exceptionDescription, e);</span>
<span class="nc" id="L468">                                }</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                            } else if (field != null) {</span>
<span class="nc" id="L470">                                value = realize0(value, field.getType(), field.getGenericType(), history);</span>
                                try {
<span class="nc" id="L472">                                    field.set(dest, value);</span>
<span class="nc" id="L473">                                } catch (IllegalAccessException e) {</span>
<span class="nc" id="L474">                                    throw new RuntimeException(&quot;Failed to set field &quot; + name + &quot; of pojo &quot; + dest.getClass().getName() + &quot; : &quot; + e.getMessage(), e);</span>
<span class="nc" id="L475">                                }</span>
                            }
                        }
                    }
<span class="nc" id="L479">                }</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">                if (dest instanceof Throwable) {</span>
<span class="nc" id="L481">                    Object message = map.get(&quot;message&quot;);</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">                    if (message instanceof String) {</span>
                        try {
<span class="nc" id="L484">                            Field field = Throwable.class.getDeclaredField(&quot;detailMessage&quot;);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                            if (!field.isAccessible()) {</span>
<span class="nc" id="L486">                                field.setAccessible(true);</span>
                            }
<span class="nc" id="L488">                            field.set(dest, message);</span>
<span class="nc" id="L489">                        } catch (Exception e) {</span>
<span class="nc" id="L490">                        }</span>
                    }
                }
<span class="nc" id="L493">                return dest;</span>
            }
        }
<span class="nc" id="L496">        return pojo;</span>
    }

    /**
     * Get parameterized type
     *
     * @param genericType generic type
     * @param index       index of the target parameterized type
     * @return Return Person.class for List&lt;Person&gt;, return Person.class for Map&lt;String, Person&gt; when index=0
     */
    private static Type getGenericClassByIndex(Type genericType, int index) {
<span class="nc" id="L507">        Type clazz = null;</span>
        // find parameterized type
<span class="nc bnc" id="L509" title="All 2 branches missed.">        if (genericType instanceof ParameterizedType) {</span>
<span class="nc" id="L510">            ParameterizedType t = (ParameterizedType) genericType;</span>
<span class="nc" id="L511">            Type[] types = t.getActualTypeArguments();</span>
<span class="nc" id="L512">            clazz = types[index];</span>
        }
<span class="nc" id="L514">        return clazz;</span>
    }

    private static Object newInstance(Class&lt;?&gt; cls) {
        try {
<span class="nc" id="L519">            return cls.newInstance();</span>
<span class="nc" id="L520">        } catch (Throwable t) {</span>
            try {
<span class="nc" id="L522">                Constructor&lt;?&gt;[] constructors = cls.getDeclaredConstructors();</span>
                /**
                 * From Javadoc java.lang.Class#getDeclaredConstructors
                 * This method returns an array of Constructor objects reflecting all the constructors
                 * declared by the class represented by this Class object.
                 * This method returns an array of length 0,
                 * if this Class object represents an interface, a primitive type, an array class, or void.
                 */
<span class="nc bnc" id="L530" title="All 2 branches missed.">                if (constructors.length == 0) {</span>
<span class="nc" id="L531">                    throw new RuntimeException(&quot;Illegal constructor: &quot; + cls.getName());</span>
                }
<span class="nc" id="L533">                Constructor&lt;?&gt; constructor = constructors[0];</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                if (constructor.getParameterTypes().length &gt; 0) {</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                    for (Constructor&lt;?&gt; c : constructors) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                        if (c.getParameterTypes().length &lt; constructor.getParameterTypes().length) {</span>
<span class="nc" id="L537">                            constructor = c;</span>
<span class="nc bnc" id="L538" title="All 2 branches missed.">                            if (constructor.getParameterTypes().length == 0) {</span>
<span class="nc" id="L539">                                break;</span>
                            }
                        }
                    }
                }
<span class="nc" id="L544">                constructor.setAccessible(true);</span>
<span class="nc" id="L545">                return constructor.newInstance(new Object[constructor.getParameterTypes().length]);</span>
<span class="nc" id="L546">            } catch (InstantiationException e) {</span>
<span class="nc" id="L547">                throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L548">            } catch (IllegalAccessException e) {</span>
<span class="nc" id="L549">                throw new RuntimeException(e.getMessage(), e);</span>
<span class="nc" id="L550">            } catch (InvocationTargetException e) {</span>
<span class="nc" id="L551">                throw new RuntimeException(e.getMessage(), e);</span>
            }
        }
    }

    private static Method getSetterMethod(Class&lt;?&gt; cls, String property, Class&lt;?&gt; valueCls) {
<span class="nc" id="L557">        String name = &quot;set&quot; + property.substring(0, 1).toUpperCase() + property.substring(1);</span>
<span class="nc" id="L558">        Method method = NAME_METHODS_CACHE.get(cls.getName() + &quot;.&quot; + name + &quot;(&quot; + valueCls.getName() + &quot;)&quot;);</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">        if (method == null) {</span>
            try {
<span class="nc" id="L561">                method = cls.getMethod(name, valueCls);</span>
<span class="nc" id="L562">            } catch (NoSuchMethodException e) {</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">                for (Method m : cls.getMethods()) {</span>
<span class="nc bnc" id="L564" title="All 4 branches missed.">                    if (ReflectUtils.isBeanPropertyWriteMethod(m) &amp;&amp; m.getName().equals(name)) {</span>
<span class="nc" id="L565">                        method = m;</span>
                    }
                }
<span class="nc" id="L568">            }</span>
<span class="nc bnc" id="L569" title="All 2 branches missed.">            if (method != null) {</span>
<span class="nc" id="L570">                NAME_METHODS_CACHE.put(cls.getName() + &quot;.&quot; + name + &quot;(&quot; + valueCls.getName() + &quot;)&quot;, method);</span>
            }
        }
<span class="nc" id="L573">        return method;</span>
    }

    private static Field getField(Class&lt;?&gt; cls, String fieldName) {
<span class="nc" id="L577">        Field result = null;</span>
<span class="nc bnc" id="L578" title="All 4 branches missed.">        if (CLASS_FIELD_CACHE.containsKey(cls) &amp;&amp; CLASS_FIELD_CACHE.get(cls).containsKey(fieldName)) {</span>
<span class="nc" id="L579">            return CLASS_FIELD_CACHE.get(cls).get(fieldName);</span>
        }
        try {
<span class="nc" id="L582">            result = cls.getDeclaredField(fieldName);</span>
<span class="nc" id="L583">            result.setAccessible(true);</span>
<span class="nc" id="L584">        } catch (NoSuchFieldException e) {</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">            for (Field field : cls.getFields()) {</span>
<span class="nc bnc" id="L586" title="All 4 branches missed.">                if (fieldName.equals(field.getName()) &amp;&amp; ReflectUtils.isPublicInstanceField(field)) {</span>
<span class="nc" id="L587">                    result = field;</span>
<span class="nc" id="L588">                    break;</span>
                }
            }
<span class="nc" id="L591">        }</span>
<span class="nc bnc" id="L592" title="All 2 branches missed.">        if (result != null) {</span>
<span class="nc" id="L593">            ConcurrentMap&lt;String, Field&gt; fields = CLASS_FIELD_CACHE.get(cls);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">            if (fields == null) {</span>
<span class="nc" id="L595">                fields = new ConcurrentHashMap&lt;String, Field&gt;();</span>
<span class="nc" id="L596">                CLASS_FIELD_CACHE.putIfAbsent(cls, fields);</span>
            }
<span class="nc" id="L598">            fields = CLASS_FIELD_CACHE.get(cls);</span>
<span class="nc" id="L599">            fields.putIfAbsent(fieldName, result);</span>
        }
<span class="nc" id="L601">        return result;</span>
    }

    public static boolean isPojo(Class&lt;?&gt; cls) {
<span class="nc bnc" id="L605" title="All 2 branches missed.">        return !ReflectUtils.isPrimitives(cls)</span>
<span class="nc bnc" id="L606" title="All 2 branches missed.">                &amp;&amp; !Collection.class.isAssignableFrom(cls)</span>
<span class="nc bnc" id="L607" title="All 2 branches missed.">                &amp;&amp; !Map.class.isAssignableFrom(cls);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>